# Chillow 要件定義書

## 【概要】
Chillow は WebSocket を用いたリアルタイムチャットアプリケーションです。  
Googleアカウントでログインし、友達との個別チャットが可能。  
ゆったりと会話できる「Chill」な空間を提供します。

---

## 【システム構成】

- フロントエンド：React.js (TypeScript) + Vite + Recoil + Tailwind CSS
- バックエンド：Go (Gin, GORM, WebSocket 自前実装)
- データベース：MySQL 8.x
- 認証基盤：Google Identity Services (OAuth2.0 / ID Token)
- ストレージ：ローカルファイルシステム or S3 互換バケット
- インフラ/開発ツール：Docker（開発環境向けコンテナ運用）、Makefile（ビルド/タスク統合）

---

## 【機能要件】

### ▶ 認証
- Google OAuth 2.0 によるログイン・新規登録
- 登録時にニックネームを設定（後から変更可能）

### ▶ 友達機能
- フレンドコードによる検索で友達追加
- 申請方式（相手の承認が必要）
- 友達の削除
- フレンド削除時は当該ユーザー間の会話データ（メッセージ・既読レコード・添付ファイル）をまとめてパージし、再申請時は新規ルームとして扱う

### ▶ チャット
- 1対1の個人チャット（WebSocketによるリアルタイム通信）
- メッセージ履歴の保存
- 既読・未読管理（ユーザー×メッセージ単位で永続化）
- 自分の送信メッセージの編集／削除
- 画像・スタンプ（プリセット）・絵文字の送信  
  - スタンプと絵文字単体は編集不可（見た目崩れ防止のため）  
  - テキストに絵文字を混在させた場合はテキスト扱いで編集可能
- 添付はローカルストレージ or S3 互換バケットへの保存に対応し、削除時は実ファイルもクリーンアップ

### ▶ マイページ
- Googleアバターとニックネームの表示
- ニックネームの編集
- ログアウト
- アカウント削除（確認あり）

---

## 【画面構成】

### トップ画面（`/`）
「ホーム」タブ
- プロフィール表示（ニックネーム・アバター）
- 友達一覧（追加順・かな順でソート可能）
- 友達のステータス（オンライン / オフライン、最終メッセージ時刻）
- 右上に「友達追加ボタン（+）」あり

### トーク画面（`/chat`）
「トーク」タブ
- チャット一覧（更新順に並べる）
- 各項目：アイコン・名前・最新メッセージの抜粋・時刻・未読件数
- クリックで個別チャット（`/chat/:id`）に遷移

### 個別チャット画面（`/chat/:id`）
- 上部：相手の名前と「戻るボタン」
- 中央：チャット履歴（吹き出し表示）
- 下部：入力欄と送信ボタン

### マイページ（`/mypage`）
「設定」タブ
- Googleアバターとニックネームの表示
- ニックネーム編集フォーム
- ログアウトボタン
- アカウント削除（注意表示付き）

---

## 【追加仕様】

### ▶ 友達追加方式
- 登録時に一意なフレンドコード（例：`U123ABC`）を生成
- 検索→申請→相手が承認→友達成立
- 中間テーブルで申請状態（`pending`, `accepted`, `rejected`）を管理
- フレンド解除時は対象ルームに `room:revoked` イベントを送信し、接続中の WebSocket を強制的に離脱させる

### ▶ 通知機能
- WebSocket によるリアルタイム通知
- 新着メッセージで通知音＋チャット一覧に未読バッジ表示
- PWA通知（後日対応可能）

### ▶ メッセージ管理
- 自分の送信メッセージの削除機能あり（片側 or 両側）
- チャット画面を開いた時点で既読に変更
- 未読状態に応じて通知表示を制御
- タイピングインジケータ／オンライン状態表示を提供
- フレンド解除で該当スレッドは即時に論理削除→物理削除（DB・添付ストレージ）され、不要な履歴が蓄積しない

### ▶ バリデーション
- ニックネームは重複可（識別はメール or フレンドコード）
- 入力文字数・禁止語句などは別途定義予定

---

## 【今後の開発項目】

- ER図の作成（users, friends, messages, message_reads など）
- API仕様書（REST + WebSocket）
- テスト計画（ユニット, 結合, E2E）
- UIモックアップ・スタイルガイド（Figma等）
- PWA対応 / ネイティブアプリ展開計画
