# Goãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸
FROM golang:1.24-bookworm AS builder

WORKDIR /app

# ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ã«opensslã‚’è¿½åŠ ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ä»Šå›ã¯ä¸è¦ï¼‰
RUN apt-get update && \
    apt-get install -y openssl && \
    rm -rf /var/lib/apt/lists/*

COPY go.mod go.sum ./
RUN go mod download

COPY . .
RUN go build -o server

# å®Ÿè¡Œã‚¹ãƒ†ãƒ¼ã‚¸
FROM debian:bookworm-slim
WORKDIR /app

# ğŸ”§ openssl + ca-certificates ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && \
    apt-get install -y \
        openssl \
        ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# ã‚µãƒ¼ãƒãƒ¼ã¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼
COPY --from=builder /app/server .
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# SSLè¨¼æ˜æ›¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
RUN mkdir -p /app/cert

EXPOSE 8443

# ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
ENTRYPOINT ["/entrypoint.sh"]

